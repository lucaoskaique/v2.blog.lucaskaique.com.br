name: This Week in Rust - Portuguese Translation

on:
  schedule:
    - cron: '0 12 * * 3'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  translate-twir:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup GitHub Copilot CLI
        uses: mvkaran/setup-copilot-cli@v1
        with:
          version: 'latest'
          token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Check Copilot CLI version
        run: copilot --version

      - name: Ask Copilot for help
        run: copilot -i "hi how are u?"

      - name: Install Python dependencies
        run: pip install feedparser

      - name: Fetch latest This Week in Rust
        id: fetch_twir
        run: |
          set -euo pipefail

          # Make script executable
          chmod +x .github/scripts/fetch_twir.py

          # Run Python script to fetch and parse RSS
          echo "Fetching This Week in Rust from RSS feed..."
          if ! python3 .github/scripts/fetch_twir.py > /tmp/twir-output.txt 2>&1; then
            echo "ERROR: Failed to fetch TWIR content"
            cat /tmp/twir-output.txt
            exit 1
          fi

          echo "RSS feed fetched successfully"

          # Verify the output file exists and has content
          if [ ! -s /tmp/twir-output.txt ]; then
            echo "ERROR: Output file is empty or does not exist"
            exit 1
          fi

          # Parse the output
          TITLE=$(grep -m 1 "^TITLE=" /tmp/twir-output.txt | sed 's/^TITLE=//' || echo "")
          LINK=$(grep -m 1 "^LINK=" /tmp/twir-output.txt | sed 's/^LINK=//' || echo "")
          SLUG=$(grep -m 1 "^SLUG=" /tmp/twir-output.txt | sed 's/^SLUG=//' || echo "")

          # Verify we got the variables
          if [ -z "$TITLE" ] || [ -z "$LINK" ] || [ -z "$SLUG" ]; then
            echo "ERROR: Failed to parse metadata from output"
            echo "TITLE: $TITLE"
            echo "LINK: $LINK"
            echo "SLUG: $SLUG"
            echo "Output file content:"
            cat /tmp/twir-output.txt
            exit 1
          fi

          # Extract content between markers
          sed -n '/--- CONTENT START ---/,/--- CONTENT END ---/p' /tmp/twir-output.txt | \
            sed '1d;$d' > /tmp/twir-content.txt

          # Verify content file was created and has content
          if [ ! -s /tmp/twir-content.txt ]; then
            echo "ERROR: Content file is empty or was not created"
            echo "Output file content:"
            cat /tmp/twir-output.txt
            exit 1
          fi

          echo "Content extracted successfully ($(wc -l < /tmp/twir-content.txt) lines)"

          DATE=$(date +%Y-%m-%d)
          DATETIME=$(date +"%Y-%m-%d %H:%M:%S")

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "link=$LINK" >> "$GITHUB_OUTPUT"
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "datetime=$DATETIME" >> "$GITHUB_OUTPUT"

          echo "Encontrado: $TITLE"
          echo "Link: $LINK"
          echo "Slug: $SLUG"

      - name: Translate with GitHub Copilot
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TITLE="${{ steps.fetch_twir.outputs.title }}"
          LINK="${{ steps.fetch_twir.outputs.link }}"
          SLUG="${{ steps.fetch_twir.outputs.slug }}"
          DATETIME="${{ steps.fetch_twir.outputs.datetime }}"

          echo "Translation parameters:"
          echo "  Title: $TITLE"
          echo "  Slug: $SLUG"

          # Verify content file exists
          if [ ! -f /tmp/twir-content.txt ]; then
            echo "ERROR: /tmp/twir-content.txt does not exist!"
            echo "This means the previous step failed to create the content file."
            exit 1
          fi

          echo "  Content size: $(wc -c < /tmp/twir-content.txt) bytes"

          cat > /tmp/translation-prompt.txt << 'PROMPT_EOF'
            Translate the following This Week in Rust newsletter content from English to Brazilian Portuguese (pt-BR).

            IMPORTANT RULES:
            - Maintain ALL markdown formatting exactly as is
            - Keep ALL code blocks unchanged
            - Keep ALL URLs and links unchanged
            - Keep technical terms in English when appropriate (Rust, crate, trait, RFC, etc.)
            - Use natural Brazilian Portuguese
            - Do NOT add any extra commentary or explanations
            - Output ONLY the translated content

            Content to translate:
          PROMPT_EOF

          cat /tmp/twir-content.txt >> /tmp/translation-prompt.txt

          echo "Starting translation with GitHub Copilot..."
          if ! copilot -i "$(cat /tmp/translation-prompt.txt)" > /tmp/translated-content.txt 2>&1; then
            echo "ERROR: Copilot translation failed"
            echo "Output:"
            cat /tmp/translated-content.txt
            exit 1
          fi

          echo "Traducao concluida"

          TRANSLATED=$(cat /tmp/translated-content.txt)

          mkdir -p posts

          {
            printf '%s\n' "---"
            printf '%s\n' "pt-BR:"
            printf '%s\n' "  layout: post"
            printf '%s\n' "  date: $DATETIME"
            printf '%s\n' "  image: /images/ESSA-SEMANA-COM-RUST-FINAL.png"
            printf '%s\n' "  main-class: rust"
            printf '%s\n' "  color: '#CE422B'"
            printf '%s\n' "  tags:"
            printf '%s\n' "    - rust"
            printf '%s\n' "    - newsletter"
            printf '%s\n' "    - this-week-in-rust"
            printf '%s\n' "    - traducao"
            printf "  title: '%s'\n" "$TITLE"
            printf '%s\n' "  description: Traducao em portugues da newsletter This Week in Rust"
            printf '%s\n' "  body: |"
            echo "$TRANSLATED" | sed 's/^/    /'
            printf '%s\n' "    "
            printf '%s\n' "    ---"
            printf '%s\n' "    "
            printf "    *Artigo original: [%s](%s)*\n" "$TITLE" "$LINK"
            printf '%s\n' "    "
            printf '%s\n' "    *Traduzido automaticamente com GitHub Copilot. Para sugestoes de melhorias na traducao, abra uma issue.*"
            printf '%s\n' "---"
          } > "posts/${SLUG}.md"

          echo "Post criado: posts/${SLUG}.md"

      - name: Check if new post was created
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain posts/)" ]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
            NEW_POST=$(git status --porcelain posts/ | head -1 | awk '{print $2}')
            echo "new_post=$NEW_POST" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: add This Week in Rust translation (Portuguese)'
          title: 'This Week in Rust - Traducao em Portugues'
          body: |
            ## Nova traducao This Week in Rust

            Esta PR adiciona automaticamente a traducao em portugues da ultima edicao do This Week in Rust.

            **Arquivo criado:** `${{ steps.check_changes.outputs.new_post }}`

            ### Revisao necessaria
            - [ ] Verificar qualidade da traducao
            - [ ] Revisar formatacao do markdown
            - [ ] Confirmar metadados (tags, categorias)
            - [ ] Verificar links e referencias

            ---
            *Esta PR foi gerada automaticamente pelo workflow twir-translator*
          branch: twir-translation-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            content
            translation
